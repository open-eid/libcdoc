<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libcdoc: Basic libcdoc Library Usage</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">libcdoc<span id="projectnumber">&#160;0.1.8</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md__2home_2runner_2work_2libcdoc_2libcdoc_2doc_2usage.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<div><div class="header">
  <div class="headertitle"><div class="title">Basic libcdoc Library Usage</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md12"></a> This document provides an overview of how to use the <b>libcdoc</b> library for encryption and decryption workflows.</p>
<hr  />
<h1><a class="anchor" id="autotoc_md14"></a>
CDOC1 vs. CDOC2 Formats</h1>
<p>The <b>libcdoc</b> library supports two container formats:</p>
<ul>
<li><b>CDOC1</b>: A legacy format suitable for compatibility with older systems. It provides basic encryption and decryption functionality.</li>
<li><b>CDOC2</b>: A modern format with enhanced security features, such as key-server integration and improved cryptographic algorithms.</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md16"></a>
Common</h1>
<p>The <b>libcdoc</b> library is built around three main components that work together to handle encryption, decryption, and key management. It is compatible with Windows, macOS, and Linux for desktop environments, as well as iOS and Android for mobile platforms:</p>
<ol type="1">
<li><b><a class="el" href="structlibcdoc_1_1CryptoBackend.html" title="An authentication provider.">libcdoc::CryptoBackend</a></b> <br  />
 Handles cryptographic operations such as key management, encryption, and decryption. This is the core component responsible for all cryptographic logic.</li>
<li><b><a class="el" href="structlibcdoc_1_1NetworkBackend.html">libcdoc::NetworkBackend</a></b> <br  />
 Manages interactions with external key-servers. This component is optional and is only required if your workflow involves fetching or storing keys on a remote server.</li>
<li><b><a class="el" href="structlibcdoc_1_1Configuration.html" title="A configuration provider.">libcdoc::Configuration</a></b> <br  />
 Provides configuration parameters, such as key-server URLs and certificates, to the <code><a class="el" href="structlibcdoc_1_1NetworkBackend.html">libcdoc::NetworkBackend</a></code>. This component ensures that the <code><a class="el" href="structlibcdoc_1_1NetworkBackend.html">libcdoc::NetworkBackend</a></code> has the necessary information to communicate with external servers.</li>
</ol>
<p>In addition to these backends, the library provides two key classes for working with CDOC containers:</p>
<ul>
<li><b><a class="el" href="classlibcdoc_1_1CDocWriter.html" title="Provides encryption interface.">libcdoc::CDocWriter</a></b>: Used for creating encrypted CDOC containers. It supports both CDOC1 and CDOC2 formats, allowing you to specify the desired version during the encryption process.</li>
<li><b><a class="el" href="classlibcdoc_1_1CDocReader.html" title="Provides decryption interface.">libcdoc::CDocReader</a></b>: Used for reading and decrypting CDOC containers. It can automatically detect whether a container is in CDOC1 or CDOC2 format.</li>
</ul>
<p>These components interact with each other to enable secure encryption and decryption workflows. The following diagram illustrates their relationships:</p>
<div class="fragment"><div class="line">+-------------------+       +-------------------+</div>
<div class="line">|   CryptoBackend   |&lt;-----&gt;|   NetworkBackend  |</div>
<div class="line">| (Handles keys,    |       | (Optional: Key    |</div>
<div class="line">| encryption/decrypt|       | server interaction|</div>
<div class="line">+-------------------+       +-------------------+</div>
<div class="line">          ^                           ^</div>
<div class="line">          |                           |</div>
<div class="line">          +---------------------------+</div>
<div class="line">                        |</div>
<div class="line">                        v</div>
<div class="line">              +-------------------+</div>
<div class="line">              |   Configuration   |</div>
<div class="line">              | (Provides key     |</div>
<div class="line">              | server parameters)|</div>
<div class="line">              +-------------------+</div>
</div><!-- fragment --><p>Most methods in the library return a <code><a class="el" href="namespacelibcdoc.html#abb349a8d9c0b8304470646b4080142c3" title="A typedef that indicates that integer value may contain libcdoc result code.">libcdoc::result_t</a></code> status value, which can indicate the following:</p>
<ul>
<li><b>OK (= 0)</b>: Indicates success.</li>
<li><b>Positive value</b>: For read and write methods, this indicates success and the number of bytes read or written.</li>
<li><b>END_OF_STREAM (= 1)</b>: For <code>nextFile</code> methods, this indicates the end of the file list in a multi-file source.</li>
<li><b>Any error value (&lt; -1)</b>: Indicates failure.</li>
</ul>
<hr  />
<h1><a class="anchor" id="autotoc_md18"></a>
Encryption</h1>
<p>Encryption is managed by the <code><a class="el" href="classlibcdoc_1_1CDocWriter.html" title="Provides encryption interface.">libcdoc::CDocWriter</a></code> object.</p>
<h2><a class="anchor" id="autotoc_md19"></a>
Workflow Diagram</h2>
<p>The following diagram illustrates the encryption workflow:</p>
<div class="fragment"><div class="line">+-------------------+       +-------------------+       +-------------------+</div>
<div class="line">|   Data Source     |       |   CryptoBackend   |       |   NetworkBackend  |</div>
<div class="line">| (e.g., file data) |       | (Handles keys,    |       | (Optional: Key    |</div>
<div class="line">|                   |       | encryption logic) |       | server interaction|</div>
<div class="line">+-------------------+       +-------------------+       +-------------------+</div>
<div class="line">          |                           |                           |</div>
<div class="line">          v                           v                           v</div>
<div class="line">      +---------------------------------------------------------------+</div>
<div class="line">      |                           CDocWriter                          |</div>
<div class="line">      | (Manages encryption process, writes encrypted container file) |</div>
<div class="line">      +---------------------------------------------------------------+</div>
<div class="line">                                      |</div>
<div class="line">                                      v</div>
<div class="line">                            +-------------------+</div>
<div class="line">                            |   Output File     |</div>
<div class="line">                            | (Encrypted CDOC)  |</div>
<div class="line">                            +-------------------+</div>
</div><!-- fragment --><hr  />
<h2><a class="anchor" id="autotoc_md21"></a>
CryptoBackend</h2>
<p>To use encryption, you must create or implement a <code><a class="el" href="structlibcdoc_1_1CryptoBackend.html" title="An authentication provider.">libcdoc::CryptoBackend</a></code> class. The default implementation is sufficient for public key encryption schemes. For symmetric key encryption, you must implement at least one of the following methods:</p>
<h3><a class="anchor" id="autotoc_md22"></a>
&lt;tt&gt;getSecret&lt;/tt&gt;</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> getSecret(std::vector&lt;uint8_t&gt;&amp; dst, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx)</div>
</div><!-- fragment --><p>This method copies either the password (for PBKDF-based keys) or the plain AES key into the <code>dst</code> vector. While simple, this method may expose the password or key in memory.</p>
<h3><a class="anchor" id="autotoc_md23"></a>
&lt;tt&gt;getKeyMaterial&lt;/tt&gt;</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> getKeyMaterial(std::vector&lt;uint8_t&gt;&amp; dst, <span class="keyword">const</span> std::vector&lt;uint8_t&gt;&amp; pw_salt, int32_t kdf_iter, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx)</div>
</div><!-- fragment --><p>This method returns the key material for a symmetric key (either password or plain key) derivation. The default implementation calls <code>getSecret</code> and performs PBKDF2_SHA256 if the key is password-based.</p>
<h3><a class="anchor" id="autotoc_md24"></a>
&lt;tt&gt;extractHKDF&lt;/tt&gt;</h3>
<div class="fragment"><div class="line">result_t extractHKDF(std::vector&lt;uint8_t&gt;&amp; dst, <span class="keyword">const</span> std::vector&lt;uint8_t&gt;&amp; salt, <span class="keyword">const</span> std::vector&lt;uint8_t&gt;&amp; pw_salt, int32_t kdf_iter, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx)</div>
</div><!-- fragment --><p>This method calculates the Key Encryption Key (KEK) pre-master from a symmetric key (either password or key-based). The default implementation calls <code>getKeyMaterial</code> and performs a local HKDF extract.</p>
<hr  />
<h2><a class="anchor" id="autotoc_md26"></a>
NetworkBackend</h2>
<p>If you intend to use a key-server, you must subclass <code><a class="el" href="structlibcdoc_1_1NetworkBackend.html">libcdoc::NetworkBackend</a></code> and implement the following methods:</p>
<h3><a class="anchor" id="autotoc_md27"></a>
&lt;tt&gt;getClientTLSCertificate&lt;/tt&gt;</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> getClientTLSCertificate(std::vector&lt;uint8_t&gt;&amp; dst)</div>
</div><!-- fragment --><p>Returns the client's TLS certificate for authentication with the key-server.</p>
<h3><a class="anchor" id="autotoc_md28"></a>
&lt;tt&gt;getPeerTLSCertificates&lt;/tt&gt;</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> getPeerTLSCertificates(std::vector&lt;std::vector&lt;uint8_t&gt;&gt; &amp;dst)</div>
</div><!-- fragment --><p>Returns the list of acceptable peer certificates for the key-server.</p>
<h3><a class="anchor" id="autotoc_md29"></a>
&lt;tt&gt;signTLS&lt;/tt&gt;</h3>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> signTLS(std::vector&lt;uint8_t&gt;&amp; dst, <a class="code hl_enumeration" href="structlibcdoc_1_1CryptoBackend.html#aef9aa7d17f928e221df06969cb073615">libcdoc::CryptoBackend::HashAlgorithm</a> algorithm, <span class="keyword">const</span> std::vector&lt;uint8_t&gt; &amp;digest)</div>
<div class="ttc" id="astructlibcdoc_1_1CryptoBackend_html_aef9aa7d17f928e221df06969cb073615"><div class="ttname"><a href="structlibcdoc_1_1CryptoBackend.html#aef9aa7d17f928e221df06969cb073615">libcdoc::CryptoBackend::HashAlgorithm</a></div><div class="ttdeci">HashAlgorithm</div><div class="ttdef"><b>Definition</b> CryptoBackend.h:48</div></div>
</div><!-- fragment --><p>Signs the provided digest for TLS authentication.</p>
<p>In addition to implementing <code><a class="el" href="structlibcdoc_1_1NetworkBackend.html">libcdoc::NetworkBackend</a></code>, you must also instantiate a <code><a class="el" href="structlibcdoc_1_1Configuration.html" title="A configuration provider.">libcdoc::Configuration</a></code> subclass.</p>
<hr  />
<h2><a class="anchor" id="autotoc_md31"></a>
Configuration</h2>
<p>The <code><a class="el" href="structlibcdoc_1_1Configuration.html" title="A configuration provider.">libcdoc::Configuration</a></code> class is required to retrieve key-server parameters. You must subclass it and implement the following method:</p>
<h3><a class="anchor" id="autotoc_md32"></a>
&lt;tt&gt;getValue&lt;/tt&gt;</h3>
<div class="fragment"><div class="line">std::string getValue(std::string_view domain, std::string_view param)</div>
</div><!-- fragment --><p>Returns the configuration value for a given domain/parameter combination. For key-servers:</p>
<ul>
<li><b>Domain</b>: The key-server ID.</li>
<li><b>Param</b>: <code>KEYSERVER_SEND_URL</code>.</li>
</ul>
<hr  />
<h2><a class="anchor" id="autotoc_md34"></a>
CDocWriter</h2>
<p>The <code><a class="el" href="classlibcdoc_1_1CDocWriter.html" title="Provides encryption interface.">libcdoc::CDocWriter</a></code> object is created using one of the following static methods:</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classlibcdoc_1_1CDocWriter.html">libcdoc::CDocWriter</a>* createWriter(<span class="keywordtype">int</span> version, <a class="code hl_struct" href="structlibcdoc_1_1DataConsumer.html">libcdoc::DataConsumer</a>* dst, <span class="keywordtype">bool</span> take_ownership, <a class="code hl_struct" href="structlibcdoc_1_1Configuration.html">libcdoc::Configuration</a>* conf, <a class="code hl_struct" href="structlibcdoc_1_1CryptoBackend.html">libcdoc::CryptoBackend</a>* crypto, <a class="code hl_struct" href="structlibcdoc_1_1NetworkBackend.html">libcdoc::NetworkBackend</a>* network);</div>
<div class="line"><a class="code hl_class" href="classlibcdoc_1_1CDocWriter.html">libcdoc::CDocWriter</a>* createWriter(<span class="keywordtype">int</span> version, std::ostream&amp; ofs, <a class="code hl_struct" href="structlibcdoc_1_1Configuration.html">libcdoc::Configuration</a>* conf, <a class="code hl_struct" href="structlibcdoc_1_1CryptoBackend.html">libcdoc::CryptoBackend</a>* crypto, <a class="code hl_struct" href="structlibcdoc_1_1NetworkBackend.html">libcdoc::NetworkBackend</a>* network);</div>
<div class="line"><a class="code hl_class" href="classlibcdoc_1_1CDocWriter.html">libcdoc::CDocWriter</a>* createWriter(<span class="keywordtype">int</span> version, <span class="keyword">const</span> std::string&amp; path, <a class="code hl_struct" href="structlibcdoc_1_1Configuration.html">libcdoc::Configuration</a>* conf, <a class="code hl_struct" href="structlibcdoc_1_1CryptoBackend.html">libcdoc::CryptoBackend</a>* crypto, <a class="code hl_struct" href="structlibcdoc_1_1NetworkBackend.html">libcdoc::NetworkBackend</a>* network);</div>
<div class="ttc" id="aclasslibcdoc_1_1CDocWriter_html"><div class="ttname"><a href="classlibcdoc_1_1CDocWriter.html">libcdoc::CDocWriter</a></div><div class="ttdoc">Provides encryption interface.</div><div class="ttdef"><b>Definition</b> CDocWriter.h:39</div></div>
<div class="ttc" id="astructlibcdoc_1_1Configuration_html"><div class="ttname"><a href="structlibcdoc_1_1Configuration.html">libcdoc::Configuration</a></div><div class="ttdoc">A configuration provider.</div><div class="ttdef"><b>Definition</b> Configuration.h:36</div></div>
<div class="ttc" id="astructlibcdoc_1_1CryptoBackend_html"><div class="ttname"><a href="structlibcdoc_1_1CryptoBackend.html">libcdoc::CryptoBackend</a></div><div class="ttdoc">An authentication provider.</div><div class="ttdef"><b>Definition</b> CryptoBackend.h:42</div></div>
<div class="ttc" id="astructlibcdoc_1_1DataConsumer_html"><div class="ttname"><a href="structlibcdoc_1_1DataConsumer.html">libcdoc::DataConsumer</a></div><div class="ttdoc">The DataConsumer class.</div><div class="ttdef"><b>Definition</b> Io.h:36</div></div>
<div class="ttc" id="astructlibcdoc_1_1NetworkBackend_html"><div class="ttname"><a href="structlibcdoc_1_1NetworkBackend.html">libcdoc::NetworkBackend</a></div><div class="ttdef"><b>Definition</b> NetworkBackend.h:26</div></div>
</div><!-- fragment --><ul>
<li>**<code>dst</code>, <code>ofs</code>, <code>path</code>**: Input stream to read file content.</li>
<li>**<code>take_ownership</code>**: Indicates if <code><a class="el" href="classlibcdoc_1_1CDocWriter.html" title="Provides encryption interface.">libcdoc::CDocWriter</a></code> takes ownership of <code>src</code> object.</li>
<li>**<code>version</code>**: Specifies the file format (1 for CDOC version 1, 2 for CDOC version 2).</li>
<li>**<code>crypto</code>**: A <code><a class="el" href="structlibcdoc_1_1CryptoBackend.html" title="An authentication provider.">libcdoc::CryptoBackend</a></code> instance (required).</li>
<li>**<code>network</code>**: A <code><a class="el" href="structlibcdoc_1_1NetworkBackend.html">libcdoc::NetworkBackend</a></code> instance (optional, for key-server use) or <code>nullptr</code>.</li>
<li>**<code>conf</code>**: A <code><a class="el" href="structlibcdoc_1_1Configuration.html" title="A configuration provider.">libcdoc::Configuration</a></code> instance (optional, for key-server use) or <code>nullptr</code>.</li>
</ul>
<p>The <code><a class="el" href="classlibcdoc_1_1CDocWriter.html" title="Provides encryption interface.">libcdoc::CDocWriter</a></code> does not take ownership of <code>crypto</code>, <code>network</code> and <code>conf</code> objects, so they should be deleted by caller.</p>
<h3><a class="anchor" id="autotoc_md35"></a>
Workflow</h3>
<ol type="1">
<li><p class="startli"><b>Add Recipients</b> <br  />
 Add one or more recipients using:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> addRecipient(<span class="keyword">const</span> Recipient&amp; rcpt);</div>
</div><!-- fragment --></li>
<li><p class="startli"><b>Begin Encryption</b> <br  />
 Start the encryption process:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> beginEncryption();</div>
</div><!-- fragment --></li>
<li><p class="startli"><b>Write Files</b> <br  />
 Add files and write their data:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> addFile(<span class="keyword">const</span> std::string&amp; name, <span class="keywordtype">size_t</span> size);</div>
<div class="line">int64_t writeData(<span class="keyword">const</span> uint8_t* src, <span class="keywordtype">size_t</span> size);</div>
</div><!-- fragment --></li>
<li><p class="startli"><b>Finish Encryption</b> <br  />
 Finalize the encryption process:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> finishEncryption();</div>
</div><!-- fragment --></li>
</ol>
<hr  />
<h2><a class="anchor" id="autotoc_md37"></a>
Implementation Example</h2>
<div class="fragment"><div class="line"><span class="keyword">struct </span>MyBackend : <span class="keyword">public</span> <a class="code hl_struct" href="structlibcdoc_1_1CryptoBackend.html">libcdoc::CryptoBackend</a> {</div>
<div class="line">    <span class="comment">/* Only needed for symmetric keys */</span></div>
<div class="line">    <span class="keywordtype">int</span> <a class="code hl_function" href="structlibcdoc_1_1CryptoBackend.html#a311eafdc241358807687b30c5ce507b8">getSecret</a>(std::vector&lt;uint8_t&gt;&amp; dst, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx) <span class="keyword">override</span> <span class="keyword">final</span> {</div>
<div class="line">        <span class="comment">/* Write secret to dst */</span></div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* In the data processing method */</span></div>
<div class="line">MyBackend crypto;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classlibcdoc_1_1CDocWriter.html">libcdoc::CDocWriter</a> *writer = createWriter(version, cdoc_filename, <span class="keyword">nullptr</span>, &amp;crypto, <span class="keyword">nullptr</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* For each recipient */</span></div>
<div class="line">writer-&gt;<a class="code hl_function" href="classlibcdoc_1_1CDocWriter.html#a9e3576c958b22fd19ac486faf9abb860">addRecipient</a>(myrcpt);</div>
<div class="line">writer-&gt;<a class="code hl_function" href="classlibcdoc_1_1CDocWriter.html#ab63c64423f1e458ad756dfb6a7275337">beginEncryption</a>();</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* For each file */</span></div>
<div class="line">writer-&gt;<a class="code hl_function" href="classlibcdoc_1_1CDocWriter.html#a088d262f9f5d96e40af3fab3a00ea9c1">addFile</a>(filename, -1);</div>
<div class="line">writer-&gt;<a class="code hl_function" href="classlibcdoc_1_1CDocWriter.html#a644c62d61160115e000110350c853d35">writeData</a>(data, data_size);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Finalize encryption */</span></div>
<div class="line">writer-&gt;<a class="code hl_function" href="classlibcdoc_1_1CDocWriter.html#a5b95a04bd6deec31246ec57e28ca72cf">finishEncryption</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">delete</span> writer;</div>
<div class="ttc" id="aclasslibcdoc_1_1CDocWriter_html_a088d262f9f5d96e40af3fab3a00ea9c1"><div class="ttname"><a href="classlibcdoc_1_1CDocWriter.html#a088d262f9f5d96e40af3fab3a00ea9c1">libcdoc::CDocWriter::addFile</a></div><div class="ttdeci">virtual result_t addFile(const std::string &amp;name, size_t size)=0</div><div class="ttdoc">Add a new file to the container.</div></div>
<div class="ttc" id="aclasslibcdoc_1_1CDocWriter_html_a5b95a04bd6deec31246ec57e28ca72cf"><div class="ttname"><a href="classlibcdoc_1_1CDocWriter.html#a5b95a04bd6deec31246ec57e28ca72cf">libcdoc::CDocWriter::finishEncryption</a></div><div class="ttdeci">virtual result_t finishEncryption()=0</div><div class="ttdoc">Finalizes the encryption stream.</div></div>
<div class="ttc" id="aclasslibcdoc_1_1CDocWriter_html_a644c62d61160115e000110350c853d35"><div class="ttname"><a href="classlibcdoc_1_1CDocWriter.html#a644c62d61160115e000110350c853d35">libcdoc::CDocWriter::writeData</a></div><div class="ttdeci">virtual result_t writeData(const uint8_t *src, size_t size)=0</div><div class="ttdoc">Write data to the encrypted stream.</div></div>
<div class="ttc" id="aclasslibcdoc_1_1CDocWriter_html_a9e3576c958b22fd19ac486faf9abb860"><div class="ttname"><a href="classlibcdoc_1_1CDocWriter.html#a9e3576c958b22fd19ac486faf9abb860">libcdoc::CDocWriter::addRecipient</a></div><div class="ttdeci">virtual result_t addRecipient(const Recipient &amp;rcpt)=0</div><div class="ttdoc">Add recipient to container.</div></div>
<div class="ttc" id="aclasslibcdoc_1_1CDocWriter_html_ab63c64423f1e458ad756dfb6a7275337"><div class="ttname"><a href="classlibcdoc_1_1CDocWriter.html#ab63c64423f1e458ad756dfb6a7275337">libcdoc::CDocWriter::beginEncryption</a></div><div class="ttdeci">virtual result_t beginEncryption()=0</div><div class="ttdoc">Prepares the stream for encryption.</div></div>
<div class="ttc" id="astructlibcdoc_1_1CryptoBackend_html_a311eafdc241358807687b30c5ce507b8"><div class="ttname"><a href="structlibcdoc_1_1CryptoBackend.html#a311eafdc241358807687b30c5ce507b8">libcdoc::CryptoBackend::getSecret</a></div><div class="ttdeci">virtual result_t getSecret(std::vector&lt; uint8_t &gt; &amp;dst, unsigned int idx)</div><div class="ttdoc">Get secret value (either password or symmetric key) for a lock.</div><div class="ttdef"><b>Definition</b> CryptoBackend.h:126</div></div>
</div><!-- fragment --><hr  />
<h1><a class="anchor" id="autotoc_md39"></a>
Decryption</h1>
<p>Decryption is managed by the <code><a class="el" href="classlibcdoc_1_1CDocReader.html" title="Provides decryption interface.">libcdoc::CDocReader</a></code> object.</p>
<h2><a class="anchor" id="autotoc_md40"></a>
Workflow Diagram</h2>
<p>The following diagram illustrates the decryption workflow:</p>
<div class="fragment"><div class="line">+-------------------+       +-------------------+       +-------------------+</div>
<div class="line">|   Input File      |       |   CryptoBackend   |       |   NetworkBackend  |</div>
<div class="line">| (Encrypted CDOC)  |       | (Handles keys,    |       | (Optional: Key    |</div>
<div class="line">|                   |       | decryption logic) |       | server interaction|</div>
<div class="line">+-------------------+       +-------------------+       +-------------------+</div>
<div class="line">          |                           |                           |</div>
<div class="line">          v                           v                           v</div>
<div class="line">      +---------------------------------------------------------------+</div>
<div class="line">      |                           CDocReader                          |</div>
<div class="line">      | (Manages decryption process, reads encrypted container file)  |</div>
<div class="line">      +---------------------------------------------------------------+</div>
<div class="line">                                      |</div>
<div class="line">                                      v</div>
<div class="line">                            +-------------------+</div>
<div class="line">                            |   Output Files    |</div>
<div class="line">                            | (Decrypted data)  |</div>
<div class="line">                            +-------------------+</div>
</div><!-- fragment --><hr  />
<h2><a class="anchor" id="autotoc_md42"></a>
CryptoBackend</h2>
<p>Create or implement a CryptoBackend class. To decrypt all lock types, at least the following methods have to be implemented:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> deriveECDH1(std::vector&lt;uint8_t&gt;&amp; dst, <span class="keyword">const</span> std::vector&lt;uint8_t&gt; &amp;public_key, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx)</div>
</div><!-- fragment --><p>Derives a shared secret from document's public key and recipient's private key by using ECDH1 algorithm.</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> decryptRSA(std::vector&lt;uint8_t&gt;&amp; dst, <span class="keyword">const</span> std::vector&lt;uint8_t&gt;&amp; data, <span class="keywordtype">bool</span> oaep, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx)</div>
</div><!-- fragment --><p>Decrypts data using RSA private key.</p>
<p>Also one of the symmetric key methods listed in encryption section for symmetric key support.</p>
<hr  />
<h2><a class="anchor" id="autotoc_md44"></a>
NetworkBackend</h2>
<p>It has to be implemented and supplied if server-based capsules are needed.</p>
<hr  />
<h2><a class="anchor" id="autotoc_md46"></a>
Configuration</h2>
<p>To decrypt server capsules, configuration has to contain the value of the following entry (domain is key-server id as in encryption):</p>
<ul>
<li>KEYSERVER_FETCH_URL</li>
</ul>
<hr  />
<h2><a class="anchor" id="autotoc_md48"></a>
CDocReader</h2>
<p>To determine whether a file or <code><a class="el" href="structlibcdoc_1_1DataSource.html" title="The DataSource class.">libcdoc::DataSource</a></code> is a valid CDOC container, use:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="classlibcdoc_1_1CDocReader.html#a420c233189c1ac2ca04bc6704f0a0b29">libcdoc::CDocReader::getCDocFileVersion</a>(<span class="keyword">const</span> std::string&amp; path);</div>
<div class="line"><span class="keywordtype">int</span> <a class="code hl_function" href="classlibcdoc_1_1CDocReader.html#a420c233189c1ac2ca04bc6704f0a0b29">libcdoc::CDocReader::getCDocFileVersion</a>(<a class="code hl_struct" href="structlibcdoc_1_1DataSource.html">libcdoc::DataSource</a> *src);</div>
<div class="ttc" id="aclasslibcdoc_1_1CDocReader_html_a420c233189c1ac2ca04bc6704f0a0b29"><div class="ttname"><a href="classlibcdoc_1_1CDocReader.html#a420c233189c1ac2ca04bc6704f0a0b29">libcdoc::CDocReader::getCDocFileVersion</a></div><div class="ttdeci">static int getCDocFileVersion(const std::string &amp;path)</div><div class="ttdoc">Try to determine the cdoc file version.</div></div>
<div class="ttc" id="astructlibcdoc_1_1DataSource_html"><div class="ttname"><a href="structlibcdoc_1_1DataSource.html">libcdoc::DataSource</a></div><div class="ttdoc">The DataSource class.</div><div class="ttdef"><b>Definition</b> Io.h:106</div></div>
</div><!-- fragment --><p>Both methods return the container version (1 or 2) or a negative value if the file/source is invalid.</p>
<p>The <code><a class="el" href="classlibcdoc_1_1CDocReader.html" title="Provides decryption interface.">libcdoc::CDocReader</a></code> has to be created with one of the following static methods:</p>
<div class="fragment"><div class="line"><a class="code hl_class" href="classlibcdoc_1_1CDocReader.html">libcdoc::CDocReader</a>* createReader(<a class="code hl_struct" href="structlibcdoc_1_1DataSource.html">libcdoc::DataSource</a>* src, <span class="keywordtype">bool</span> take_ownership, <a class="code hl_struct" href="structlibcdoc_1_1Configuration.html">libcdoc::Configuration</a>* conf, <a class="code hl_struct" href="structlibcdoc_1_1CryptoBackend.html">libcdoc::CryptoBackend</a>* crypto, <a class="code hl_struct" href="structlibcdoc_1_1NetworkBackend.html">libcdoc::NetworkBackend</a>* network);</div>
<div class="line"><a class="code hl_class" href="classlibcdoc_1_1CDocReader.html">libcdoc::CDocReader</a>* createReader(<span class="keyword">const</span> std::string&amp; path, <a class="code hl_struct" href="structlibcdoc_1_1Configuration.html">libcdoc::Configuration</a>* conf, <a class="code hl_struct" href="structlibcdoc_1_1CryptoBackend.html">libcdoc::CryptoBackend</a>* crypto, <a class="code hl_struct" href="structlibcdoc_1_1NetworkBackend.html">libcdoc::NetworkBackend</a>* network);</div>
<div class="line"><a class="code hl_class" href="classlibcdoc_1_1CDocReader.html">libcdoc::CDocReader</a>* createReader(std::istream&amp; ifs, <a class="code hl_struct" href="structlibcdoc_1_1Configuration.html">libcdoc::Configuration</a>* conf, <a class="code hl_struct" href="structlibcdoc_1_1CryptoBackend.html">libcdoc::CryptoBackend</a>* crypto, <a class="code hl_struct" href="structlibcdoc_1_1NetworkBackend.html">libcdoc::NetworkBackend</a>* network);</div>
<div class="ttc" id="aclasslibcdoc_1_1CDocReader_html"><div class="ttname"><a href="classlibcdoc_1_1CDocReader.html">libcdoc::CDocReader</a></div><div class="ttdoc">Provides decryption interface.</div><div class="ttdef"><b>Definition</b> CDocReader.h:40</div></div>
</div><!-- fragment --><ul>
<li>**<code>src</code>, <code>path</code>, <code>ifs</code>**: Input stream to read file content.</li>
<li>**<code>take_ownership</code>**: Indicates if <code><a class="el" href="classlibcdoc_1_1CDocReader.html" title="Provides decryption interface.">libcdoc::CDocReader</a></code> takes ownership of <code>src</code> object.</li>
<li>**<code>crypto</code>**: A <code><a class="el" href="structlibcdoc_1_1CryptoBackend.html" title="An authentication provider.">libcdoc::CryptoBackend</a></code> instance (required when case decrypting) or <code>nullptr</code>.</li>
<li>**<code>network</code>**: A <code><a class="el" href="structlibcdoc_1_1NetworkBackend.html">libcdoc::NetworkBackend</a></code> instance (optional, for key-server use) or <code>nullptr</code>.</li>
<li>**<code>conf</code>**: A <code><a class="el" href="structlibcdoc_1_1Configuration.html" title="A configuration provider.">libcdoc::Configuration</a></code> instance (optional, for key-server use) or <code>nullptr</code>.</li>
</ul>
<p>The <code><a class="el" href="classlibcdoc_1_1CDocReader.html" title="Provides decryption interface.">libcdoc::CDocReader</a></code> does not take ownership of <code>crypto</code>, <code>network</code> and <code>conf</code> objects, so they should be deleted by caller.</p>
<h3><a class="anchor" id="autotoc_md49"></a>
Workflow</h3>
<p>The list of locks in file can be obtained by method:</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> std::vector&lt;Lock&gt;&amp; getLocks()</div>
</div><!-- fragment --><p>The order of locks is the same as in CDoc container and the 0-based index is used to refer to the lock in decryption methods.</p>
<p>As a convenience method, a public-key lock can be looked up by a certificate (DER-encoded):</p>
<div class="fragment"><div class="line">result_t getLockForCert(<span class="keyword">const</span> std::vector&lt;uint8_t&gt;&amp; cert)</div>
</div><!-- fragment --><p>Returns the index of a lock that can be opened by the private key of the certificate, or negative number if not found.</p>
<p>Once the correct lock is chosen, the FMK (File Master Key) of the container has to be obtained:</p>
<div class="fragment"><div class="line">result_t getFMK(std::vector&lt;uint8_t&gt;&amp; fmk, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lock_idx)</div>
</div><!-- fragment --><p>Depending on the lock type the method calls appropriate methods of CryptoBackend (and NetworkBackend) implementation to obtain and decrypt FMK.</p>
<p>After that the FMK can be used to start the encryption:</p>
<div class="fragment"><div class="line">result_t beginDecryption(<span class="keyword">const</span> std::vector&lt;uint8_t&gt;&amp; fmk)</div>
</div><!-- fragment --><p>Individual files can be read by nextFile method:</p>
<div class="fragment"><div class="line">result_t nextFile(std::string&amp; name, int64_t&amp; size)</div>
</div><!-- fragment --><p>The method returns the name and size of the next file in encrypted stream, or END_OF_STREAM if there are no more files. Due to the structure of CDoc container, files have to be processed sequentially - there is no way to rewind the stream. The name returned is the <em>exact filename</em> in encrypted stream. If the application intends to save the file with the same name, it has to verify that the path is safe.</p>
<p>The actual decrypted data can be read with method:</p>
<div class="fragment"><div class="line">result_t readData(uint8_t *dst, <span class="keywordtype">size_t</span> size)</div>
</div><!-- fragment --><p>This reads the data from current file.</p>
<p>When all files are read, the finalizer has to be called:</p>
<div class="fragment"><div class="line">result_t finishDecryption()</div>
</div><!-- fragment --><p>The decrypted data should <em>not be used</em> before successful finalization because it performs the final check of data integrity. If it fails, the data should be assumed incomplete or corrupted.</p>
<hr  />
<h2><a class="anchor" id="autotoc_md51"></a>
Implementation Example</h2>
<p>Below is an example of how to implement decryption using the <code><a class="el" href="classlibcdoc_1_1CDocReader.html" title="Provides decryption interface.">libcdoc::CDocReader</a></code> object and a custom <code><a class="el" href="structlibcdoc_1_1CryptoBackend.html" title="An authentication provider.">libcdoc::CryptoBackend</a></code> subclass:</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>MyBackend : <span class="keyword">public</span> <a class="code hl_struct" href="structlibcdoc_1_1CryptoBackend.html">libcdoc::CryptoBackend</a> {</div>
<div class="line">    <span class="comment">/* Elliptic curves */</span></div>
<div class="line">    result_t deriveECDH1(std::vector&lt;uint8_t&gt;&amp; dst, <span class="keyword">const</span> std::vector&lt;uint8_t&gt; &amp;public_key, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx) <span class="keyword">override</span> <span class="keyword">final</span> {</div>
<div class="line">        <span class="comment">/* Derive shared secret and write to dst */</span></div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* RSA */</span></div>
<div class="line">    result_t decryptRSA(std::vector&lt;uint8_t&gt;&amp; dst, <span class="keyword">const</span> std::vector&lt;uint8_t&gt;&amp; data, <span class="keywordtype">bool</span> oaep, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx) <span class="keyword">override</span> <span class="keyword">final</span> {</div>
<div class="line">        <span class="comment">/* Decrypt data and write to dst */</span></div>
<div class="line">    }</div>
<div class="line">    <span class="comment">/* Only needed for symmetric keys */</span></div>
<div class="line">    <span class="keywordtype">int</span> getSecret(std::vector&lt;uint8_t&gt;&amp; dst, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> idx) <span class="keyword">override</span> <span class="keyword">final</span> {</div>
<div class="line">        <span class="comment">/* Write secret to dst */</span></div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* In the data processing method */</span></div>
<div class="line">MyBackend crypto;</div>
<div class="line"> </div>
<div class="line"><a class="code hl_class" href="classlibcdoc_1_1CDocReader.html">libcdoc::CDocReader</a>* reader = createReader(cdoc_filename, <span class="keyword">nullptr</span>, &amp;crypto, <span class="keyword">nullptr</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Get locks */</span></div>
<div class="line"><span class="keyword">auto</span> locks = reader-&gt;<a class="code hl_function" href="classlibcdoc_1_1CDocReader.html#ab6b03ff9883708fd3bbf28455828612c">getLocks</a>();</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Choose a lock that you have a key for, then decrypt FMK */</span></div>
<div class="line">std::vector&lt;uint8_t&gt; fmk;</div>
<div class="line">reader-&gt;<a class="code hl_function" href="classlibcdoc_1_1CDocReader.html#a63c861c3a129ce64ecb6c14bd8dd4546">getFMK</a>(fmk, lock_idx);</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Start decryption */</span></div>
<div class="line">reader-&gt;<a class="code hl_function" href="classlibcdoc_1_1CDocReader.html#aac634b62ae11d5d326e137fa50bbe79a">beginDecryption</a>(fmk);</div>
<div class="line">std::string name;</div>
<div class="line">int64_t size;</div>
<div class="line"><span class="keywordflow">while</span>(reader-&gt;<a class="code hl_function" href="classlibcdoc_1_1CDocReader.html#aaa7468b7469fe5908cba4d9f37802d21">nextFile</a>(name, size) == <a class="code hl_enumvalue" href="namespacelibcdoc.html#a02f56a86beadde55c0814a29bfe3ed99ae0e596081987a99bf69ad49e64e597d2">libcdoc::OK</a>) {</div>
<div class="line">    <span class="comment">/* Allocate data buffer etc... */</span></div>
<div class="line">    reader-&gt;<a class="code hl_function" href="classlibcdoc_1_1CDocReader.html#a4d3dde2e19925d43623de634d9ad18ae">readData</a>(buffer, size);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Finalize decryption */</span></div>
<div class="line">reader-&gt;<a class="code hl_function" href="classlibcdoc_1_1CDocReader.html#a44faac9b806cc9ffad553db20b564424">finishDecryption</a>();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">delete</span> reader;</div>
<div class="ttc" id="aclasslibcdoc_1_1CDocReader_html_a44faac9b806cc9ffad553db20b564424"><div class="ttname"><a href="classlibcdoc_1_1CDocReader.html#a44faac9b806cc9ffad553db20b564424">libcdoc::CDocReader::finishDecryption</a></div><div class="ttdeci">virtual result_t finishDecryption()=0</div><div class="ttdoc">Finish decrypting container.</div></div>
<div class="ttc" id="aclasslibcdoc_1_1CDocReader_html_a4d3dde2e19925d43623de634d9ad18ae"><div class="ttname"><a href="classlibcdoc_1_1CDocReader.html#a4d3dde2e19925d43623de634d9ad18ae">libcdoc::CDocReader::readData</a></div><div class="ttdeci">virtual result_t readData(uint8_t *dst, size_t size)=0</div><div class="ttdoc">Read data from the current file.</div></div>
<div class="ttc" id="aclasslibcdoc_1_1CDocReader_html_a63c861c3a129ce64ecb6c14bd8dd4546"><div class="ttname"><a href="classlibcdoc_1_1CDocReader.html#a63c861c3a129ce64ecb6c14bd8dd4546">libcdoc::CDocReader::getFMK</a></div><div class="ttdeci">virtual result_t getFMK(std::vector&lt; uint8_t &gt; &amp;fmk, unsigned int lock_idx)=0</div><div class="ttdoc">Obtain FMK of given lock.</div></div>
<div class="ttc" id="aclasslibcdoc_1_1CDocReader_html_aaa7468b7469fe5908cba4d9f37802d21"><div class="ttname"><a href="classlibcdoc_1_1CDocReader.html#aaa7468b7469fe5908cba4d9f37802d21">libcdoc::CDocReader::nextFile</a></div><div class="ttdeci">virtual result_t nextFile(std::string &amp;name, int64_t &amp;size)=0</div><div class="ttdoc">Go to the next file in container.</div></div>
<div class="ttc" id="aclasslibcdoc_1_1CDocReader_html_aac634b62ae11d5d326e137fa50bbe79a"><div class="ttname"><a href="classlibcdoc_1_1CDocReader.html#aac634b62ae11d5d326e137fa50bbe79a">libcdoc::CDocReader::beginDecryption</a></div><div class="ttdeci">virtual result_t beginDecryption(const std::vector&lt; uint8_t &gt; &amp;fmk)=0</div><div class="ttdoc">Start decrypting container.</div></div>
<div class="ttc" id="aclasslibcdoc_1_1CDocReader_html_ab6b03ff9883708fd3bbf28455828612c"><div class="ttname"><a href="classlibcdoc_1_1CDocReader.html#ab6b03ff9883708fd3bbf28455828612c">libcdoc::CDocReader::getLocks</a></div><div class="ttdeci">virtual const std::vector&lt; Lock &gt; &amp; getLocks()=0</div><div class="ttdoc">Get decryption locks in given document.</div></div>
<div class="ttc" id="anamespacelibcdoc_html_a02f56a86beadde55c0814a29bfe3ed99ae0e596081987a99bf69ad49e64e597d2"><div class="ttname"><a href="namespacelibcdoc.html#a02f56a86beadde55c0814a29bfe3ed99ae0e596081987a99bf69ad49e64e597d2">libcdoc::OK</a></div><div class="ttdeci">@ OK</div><div class="ttdoc">Operation completed successfully.</div><div class="ttdef"><b>Definition</b> CDoc.h:43</div></div>
</div><!-- fragment --><p>This example demonstrates how to:</p><ol type="1">
<li>Subclass <code><a class="el" href="structlibcdoc_1_1CryptoBackend.html" title="An authentication provider.">libcdoc::CryptoBackend</a></code> to implement the required decryption methods (<code>deriveECDH1</code> and <code>decryptRSA</code>).</li>
<li>Create a <code><a class="el" href="classlibcdoc_1_1CDocReader.html" title="Provides decryption interface.">libcdoc::CDocReader</a></code> instance and use it to process an encrypted CDOC container.</li>
<li>Retrieve locks, decrypt the File Master Key (FMK), and read the decrypted files.</li>
</ol>
<hr  />
 </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue Sep 16 2025 13:17:06 for libcdoc by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
